# üîß MOMO Backend Errors - Fixed

## Errors Identified & Fixed

### 1. ‚ùå Database Column Error
**Error**: `Could not find the 'timestamp' column of 'mtn_momo_logs'`

**Root Cause**: Code was trying to insert into a `timestamp` column that doesn't exist. The actual column is `created_at` (auto-generated by Supabase).

**Fix**: Removed the manual `timestamp` field from the insert statement. The database now auto-generates `created_at` and `updated_at` defaults.

**File**: `backend/services/mtnMomoService.js` (line 119-144)

---

### 2. ‚ùå Collection Token Error (500 from MTN MOMO API)
**Error**: `Failed to get collection access token: Request failed with status code 500`

**Root Causes**:
1. Config reading from wrong env var names:
   - ‚ùå `MOMO_API_USER` ‚Üí ‚úÖ `MOMO_API_USER_ID`
   - ‚ùå `MOMO_API_KEY` ‚Üí ‚úÖ `MOMO_API_SECRET_KEY`

2. Demo/placeholder credentials don't work with real MTN MOMO API:
   - Current: `550e8400-e29b-41d4-a716-446655440000` (demo UUID)
   - Actual: Need real MTN MOMO API credentials

**Fix**: 
- ‚úÖ Updated config to read from correct env var names
- ‚úÖ Added enhanced logging to show which credentials are being used
- ‚úÖ The backend now properly shows masked credential values for debugging

**File**: `backend/services/mtnMomoService.js` (lines 27-39, 193-200)

---

## What You Need to Do

### For Supabase Logging ‚úÖ
The fix is automatic - just restart the backend.

### For MTN MOMO API Authentication
You need **actual MTN MOMO sandbox credentials**:

1. **Get credentials from MTN**:
   - Visit: https://momodeveloper.mtn.com
   - Sign up for sandbox account
   - Create an API user (get API User ID & API Key)
   - Get your Subscription Key (Primary & Secondary keys)

2. **Update `backend/.env`**:
   ```dotenv
   MOMO_API_USER_ID=your_actual_api_user_id
   MOMO_API_SECRET_KEY=your_actual_api_secret_key
   MOMO_SUBSCRIPTION_KEY=your_subscription_key
   ```

3. **Restart backend**:
   ```bash
   cd backend
   npm start
   ```

4. **Check backend logs**:
   You should now see:
   ```
   üîê Fetching new collection access token from MTN...
      Using credentials:
      apiUser: 550e8400-e...
      apiKey: 0c831535c...
      subscriptionKey: 8b59afc4...
   ‚úÖ Got new collection token (expires in 3600s)
   ```

---

## Testing

After updating credentials:

1. **Restart Backend**
   ```bash
   cd backend
   npm start
   ```

2. **Test in Frontend**
   - Go to ICAN Wallet
   - Try MOMO top-up with MTN phone number
   - Should see success (or specific error if credentials still wrong)

3. **Check Logs**
   - Backend console should show token acquisition
   - Supabase table should have transaction logs

---

## Important Notes

- **Demo credentials**: The values currently in `.env` are placeholders and won't work with MTN API
- **Sandbox vs Production**: We're using sandbox URL - fine for testing but need production URL & credentials for real transactions
- **Token caching**: Backend caches tokens in memory and Supabase to reduce API calls
- **Error logging**: All errors are now logged to `mtn_momo_logs` table

---

## Files Modified

1. `backend/services/mtnMomoService.js`:
   - Line 27-39: Fixed env var names in config
   - Line 119-144: Fixed database column name (timestamp ‚Üí created_at)
   - Line 193-200: Added credential logging for debugging

2. `frontend/src/services/momoService.js`:
   - Line 330-340: Enhanced error response logging
